# EXPP Migration Progress

## Phase A.1: Root Monorepo Configuration ✓
- Created root package.json with Bun workspaces configuration
- Configured workspaces: apps/*, packages/*
- Added root-level scripts: dev, build, typecheck, lint, db:*
- Removed old lockfiles (npm and bun) from frontend/ and backend/
- Created apps/ and packages/ directories
- Updated .gitignore for monorepo structure

## Phase A.2: Database Package with Drizzle Schema ✓
- Created packages/db/ with complete Drizzle ORM setup
- Defined 18 tables in schema.ts:
  * 4 Auth.js tables (users, accounts, sessions, verification_tokens)
  * 14 application tables (profiles, tasks, task_sheets, submissions, statistics, etc.)
- Configured Drizzle with postgres driver
- Created migration runner script
- Generated initial migration: drizzle/0000_great_echo.sql

## Phase A.3: Create Next.js app scaffold ✓
- Created apps/web/ with Next.js 15 App Router configuration
- Configured TypeScript with strict mode and path aliases (@/*)
- Set up Tailwind CSS with PostCSS
- Created minimal app structure:
  * src/app/layout.tsx (root layout with metadata)
  * src/app/page.tsx (home page placeholder)
  * src/app/globals.css (Tailwind directives + CSS variables)
  * Added Next.js-specific .gitignore
- Updated root package.json to include export-worker in typecheck script
- Configured Next.js with output: 'standalone' for Docker deployment

## Phase A.4: Docker Compose Configuration ✓
- Created root-level docker-compose.yml with 4 services:
  * postgres: PostgreSQL 16 with persistent volume and health checks
  * redis: Redis 7 with persistent volume, authentication, and health checks
  * web: Next.js app container using Bun
  * export-worker: Pandoc + TexLive service for PDF/DOCX exports
- Created apps/export-worker/ package:
  * package.json with Hono framework for lightweight HTTP server
  * src/index.ts with /health and /export/pdf endpoints
  * Dockerfile with Debian base + Pandoc + TexLive + Bun
- Created .env.example with all required environment variables
- Created .dockerignore for optimized Docker build context
- Updated root package.json to include export-worker in typecheck script
- Configured Next.js with output: 'standalone' for Docker deployment

## Phase A.5: Auth.js Configuration with Database Adapter ✓
- Added password field to users table in database schema
- Generated new migration (0001_closed_giant_man.sql) for password field
- Installed Auth.js dependencies in apps/web:
  * next-auth@5.0.0-beta.30
  * @auth/drizzle-adapter@1.11.1
  * bcryptjs@3.0.3
  * zod@4.3.6
  * ioredis@5.9.2
  * @types/bcryptjs@3.0.0
  * Added @expp/db workspace dependency to apps/web
- Configured Auth.js with Drizzle adapter in apps/web/src/lib/auth.ts
- Created authentication providers:
  * Credentials provider (email/password with bcrypt hashing)
  * Google OAuth provider
- Configured database session strategy (30 day expiration)
- Implemented auto-profile creation on signup:
  * Creates profile entry in profiles table
  * Creates user_settings entry with defaults (theme, language, notifications)
  * Creates user_statistics entry with initial values
- Created Auth.js API route handler at /api/auth/[...nextauth]/route.ts
- Created authentication helper functions in apps/web/src/lib/auth-helpers.ts:
  * getSession() - Get current session server-side
  * getCurrentUser() - Get current user from session
  * requireAuth() - Require authentication with redirect
  * getUserId() - Get authenticated user ID
  * registerUser() - Register new user with email/password
  * changePassword() - Change user password
  * getUserProfile() - Get user profile data
  * verifyOwnership() - Verify resource ownership
- Created API routes:
  * POST /api/auth/register - User registration endpoint
  * POST /api/auth/change-password - Password change endpoint
- Updated packages/db/src/index.ts to re-export drizzle-orm functions (eq, and, or, not, sql)
- Migration file: packages/db/drizzle/0001_closed_giant_man.sql

## Phase B.0: Infrastructure Setup ✓
- Created Redis client singleton with retry logic (apps/web/src/lib/redis.ts)
- Created rate limiting utilities with sliding window algorithm (apps/web/src/lib/rate-limit.ts)
- Created API helper functions for errors, pagination, validation (apps/web/src/lib/api-helpers.ts)
- Created avatar storage utilities for local file uploads (apps/web/src/lib/avatar-storage.ts)
- Added full-text search migration for tasks table (packages/db/drizzle/0002_add_fulltext_index.sql)
- Updated docker-compose.yml with avatar_uploads volume and UPLOAD_DIR environment variable

## Phase B.1: Tasks API ✓
- GET /api/tasks - List tasks with pagination, filtering (type, topic, difficulty)
- POST /api/tasks - Bulk upsert tasks (insert or update on conflict)
- DELETE /api/tasks - Soft delete tasks (set deletedAt timestamp)
- GET /api/tasks/[id] - Get single task by ID with ownership check
- PATCH /api/tasks/[id] - Update task with ownership check

## Phase B.2: Sheets API ✓
- GET /api/sheets - List sheets with pagination, filtering (isTemplate, tags)
- POST /api/sheets - Create new sheet
- DELETE /api/sheets - Delete multiple sheets (ownership verified)
- GET /api/sheets/[id] - Get single sheet by ID with ownership check
- PUT /api/sheets/[id] - Update sheet with ownership check
- POST /api/sheets/[id]/copy - Copy sheet with optional new title
- POST /api/sheets/[id]/share - Share sheet with another user (checks recipient exists)
- GET /api/sheets/[id]/versions - List sheet versions with pagination
- POST /api/sheets/[id]/versions - Create new version (snapshot)

## Phase B.3: Profile API ✓
- GET /api/profile - Get current user's profile
- PUT /api/profile - Update profile (firstName, lastName, avatarUrl, preferences)
- POST /api/profile/avatar - Upload avatar image and update profile

## Phase B.4: Settings API ✓
- GET /api/settings - Get user settings, auto-create defaults if missing
- PUT /api/settings - Update user settings (theme, language, notificationsEnabled, preferences)

## Phase B.5: Statistics API ✓
- GET /api/statistics - Get user statistics with auto-initialization
- GET /api/statistics/progress - Get user progress data for a date range (query param: days, default 30)

## Phase B.6: Submissions API ✓
- POST /api/submissions/task - Submit task answer with statistics updates
- POST /api/submissions/sheet - Submit completed sheets with statistics updates
- GET /api/submissions/task - List task submissions
- GET /api/submissions/sheet - List sheet submissions

## Phase B.7: Search API ✓
- GET /api/search - Full-text search using PostgreSQL tsvector index

## Phase B.8: OpenAI Chat API ✓
- POST /api/openai/chat - OpenAI chat completions proxy
- Applied Redis rate limiting: 10 requests per minute per user
- Added rate limit headers (X-RateLimit-Limit, X-RateLimit-Remaining, Retry-After)

## Phase B.9: Export API ✓
- POST /api/export - Export content to PDF or DOCX via export-worker service
- Applied Redis rate limiting: 5 requests per minute per user
- Enhanced export-worker to support DOCX format
- Added rate limit headers (X-RateLimit-Limit, X-RateLimit-Remaining, Retry-After)

## Phase C.1: Unified API Client ✓
- Created unified API client for all frontend API calls (apps/web/src/lib/api-client.ts)
- Provides type-safe methods for all API endpoints with:
  * Consistent error handling
  * Automatic authentication header injection
  * Type-safe request/response handling
  * Support for both client and server components

## Phase C.2: Update Auth Store to Use Auth.js ✓
- Deleted old authStore.ts (client-side Zustand store)
- Created new auth-client.ts using Auth.js hooks (useAuth, useSession, useIsAuthenticated)
- Provides similar interface to old authStore with:
  * signIn(), signUp(), signInWithGoogle(), signOut(), changePassword()
- Replaced all authStore usage with useAuth() in client components

## Phase C.3: Migrate Core Pages (Profile, Settings, TaskLibrary, SheetsLibrary) ✓
- Created shared UI components (Button, Toast, PageLayout, Navigation)
- Created Profile page (/profile) with:
  * Profile information display and editing
  * Avatar upload functionality
  * Password change functionality
  * Statistics overview cards
  * Uses API client for data fetching
  * Uses useAuth hook for authentication
- Created Settings page (/settings) with:
  * Theme selection (light, dark, system)
  * Language selection (en, ru, kk)
  * Notification settings (enabled, email, reminders)
  * Privacy settings (public profile)
  * Uses API client for settings management
- Created Task Library page (/tasks) with:
  * Search and filter functionality
  * Grid/List view modes
  * Sorting options (date, topic, difficulty, type)
  * Task cards with expand/collapse answers
  * Bulk delete functionality
  * Uses API client for task management
- Created Sheets Library page (/sheets) with:
  * Search functionality
  * Grid/List view modes
  * Sorting options (date, title, tasks count)
  * Sheet cards with quick actions (view, edit, copy, delete)
  * Create new sheet modal
  * Uses API client for sheet management
- Created Navigation component with:
  * Desktop and mobile menu support
  * Auth-aware rendering (hides sign in/sign up when logged in)
  * Active link highlighting
  * User profile display with avatar
  * Sign out functionality
  * All routes use Next.js App Router

### Files Created:
- apps/web/src/lib/utils.ts (cn utility for class merging)
- apps/web/src/components/ui/button.tsx (Button component)
- apps/web/src/components/ui/toast.tsx (Toaster component)
- apps/web/src/components/ui/index.ts (UI exports)
- apps/web/src/components/layout/page-layout.tsx (PageLayout with 6xl support)
- apps/web/src/components/layout/index.ts (Layout exports)
- apps/web/src/components/layout/Navigation.tsx (Navigation component)
- apps/web/src/components/index.ts (Component exports)
- apps/web/src/hooks/use-toast.ts (useToast hook)
- apps/web/src/hooks/index.ts (Hook exports)
- apps/web/src/app/auth/signin/page.tsx (Sign-in page)
- apps/web/src/app/profile/page.tsx (Profile page)
- apps/web/src/app/settings/page.tsx (Settings page)
- apps/web/src/app/tasks/page.tsx (Task Library page)
- apps/web/src/app/sheets/page.tsx (Sheets Library page)

### Commands Run:
```bash
bun run typecheck  # ✓ Passed (all workspaces)
```

### Verification Results:
- TypeScript: ✓ No errors
- All API routes: ✓ 15 endpoints implemented
- All core pages: ✓ 5 pages created
- Components: ✓ All shared components created
- API Client: ✓ Type-safe with proper error handling
- Toast: ✓ Integrated with sonner
- Patterns established:
  * 'use client' directive for interactive components
  * API client usage with consistent error handling
  * useAuth hook for authentication state
  * useToast hook for notifications
  * Framer Motion for animations
  * Tailwind CSS for styling with dark mode support
  * Responsive design with mobile menu

### Architecture Notes:
- All pages use Next.js App Router conventions
- Server-side authentication via NextAuth.js sessions
- Client-side state management with React hooks
- Type-safe API calls with proper error handling
- Component composition with shared UI elements
- Form validation with Zod schemas
- Database access via Drizzle ORM with PostgreSQL
- Redis for rate limiting and caching
- Export worker for PDF/DOCX generation via Pandoc + TexLive

### Next Steps:
- Phase C.4: Migrate remaining components (Statistics, Home page, etc.)
- Phase C.5: Update types and cleanup
- Phase C.6: Delete old Supabase service files
- Run build verification: `bun run build`

### Remaining Features to Migrate:
- Study Groups (if ENABLE_STUDY_GROUPS in old frontend)
- Statistics detail pages
- Task completion/preview pages
- OpenAI chat integration page
- Export modal enhancements
- Task edit/create modals
- Sheet analytics
- Advanced filtering options
- Task library bulk actions (export, save as sheet)
- Interactive markdown editor for task/solution
- Real-time collaboration features
- Offline mode support
